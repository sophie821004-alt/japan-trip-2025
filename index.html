<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SL Japan Travel 2025</title>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Playfair+Display:wght=700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <script>
        // 2. æ‚¨çš„ Firebase é…ç½®åƒæ•¸
        const firebaseConfig = {
            apiKey: "AIzaSyDTXrRd2JDqzHf8n7p9L6bWKKFwxwrHit0",
            authDomain: "japan-trip-2025-172dc.firebaseapp.com",
            projectId: "japan-trip-2025-172dc",
            storageBucket: "japan-trip-2025-172dc.firebasestorage.app",
            messagingSenderId: "1017170036072",
            appId: "1:1017170036072:web:56e15a34af9aedec1fc2dd",
            measurementId: "G-99GM2GD2E0"
        };
        
        // 3. å…¨åŸŸè®Šæ•¸ï¼Œç”¨æ–¼å„²å­˜è³‡æ–™åº«å¯¦ä¾‹
        let db;
        
        // 4. åˆå§‹åŒ– Firebase App
        const initializeFirebase = () => {
            if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
                const app = firebase.initializeApp(firebaseConfig);
                db = app.firestore();
                console.log("Firebase initialized successfully with Firestore.");
            }
        };
        if (typeof firebase !== 'undefined') {
            initializeFirebase();
        }

    </script>
    <style>
        /* åŸºç¤æ¨£å¼å’Œå­—é«” */
        body { 
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #FBF9F2; 
            transition: background-color 0.5s;
            -webkit-tap-highlight-color: transparent; 
        }
        /* éš±è—æ»¾å‹•æ¢ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* æ ¸å¿ƒä¸»é¡Œæ¨£å¼ */
        .theme-simple {
             background-color: #FBF9F2;
            color: #333; 
        }

        /* ç°¡ç´„æ·ºè‰²å¡ç‰‡ (ç»ç’ƒæ„Ÿ) */
        .glass-light { 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px); 
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card-shadow { box-shadow: 0 4px 25px rgba(0,0,0,0.1); }

        /* å°ˆç”¨æ–¼æ—¥æœŸçš„è¥¯ç·šå­—é«” */
        .date-style { font-family: 'Playfair Display', serif; }
        
        /* è¨­å®šåˆ†å¸³ç³»çµ±ç¶²æ ¼æ•¸ */
        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        
        /* ä¿®æ­£ React 18 è­¦å‘Š */
        #root {
            min-height: 100vh;
        }
        
        /* è²»ç”¨è¼¸å…¥æ¡†æ¨£å¼ */
        .expense-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem; /* text-sm */
            text-align: right;
            transition: border-color 0.2s;
        }
        .expense-input:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
        }

        /* ä¿®æ­£ï¼šå°‡å·¦å³é‚Šè· mx-6 æ”¹ç‚º mx-4 (æ›´é©åˆæ‰‹æ©Ÿ)ï¼Œä¸¦ç¶­æŒ mb-12 é–“è· */
        .card-container {
            margin-left: 1rem; /* mx-4 */
            margin-right: 1rem; /* mx-4 */
            margin-bottom: 3rem; /* mb-12 */
        }

        /* æ–°å¢ï¼šåœ°åœ–æª¢è¦–å™¨æ¨£å¼ */
        .map-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .map-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            cursor: zoom-out;
            transition: transform 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-[#FBF9F2] text-gray-800 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;
        const TRAVELERS = ['Sophie', 'Li'];
        
        // --- Custom Hook: useLocalStorageState (é›¢ç·šå„²å­˜æ ¸å¿ƒ) ---
        const useLocalStorageState = (key, defaultValue) => {
            const [state, setState] = useState(() => {
                try {
                    const value = localStorage.getItem(key);
                    if (value) {
                        return JSON.parse(value);
                    }
                } catch (error) {
                    console.error("Error reading localStorage key â€œ" + key + "â€:", error);
                }
                return defaultValue;
            });
            useEffect(() => {
                try {
                    localStorage.setItem(key, JSON.stringify(state));
                } catch (error) {
                    console.error("Error writing localStorage key â€œ" + key + "â€:", error);
                }
            }, [key, state]);
            return [state, setState];
        };
        
        // --- DATA SOURCE & CONFIGS (è¡Œç¨‹è³‡æ–™ - ä¿æŒä¸è®Š) ---

        const toolsData = {
            flights: [
                { leg: "å»ç¨‹", code: "IT206", time: "12/20 09:00 TPE -> 14:00 NGO", airport: "TPE/NGO" },
                { leg: "å›ç¨‹", code: "MM625", time: "12/28 16:35 NRT -> 20:00 TPE", airport: "NRT T1" }
            ],
            hotels: [
                { 
                    name: "VIA INN åå¤å±‹ç«™å‰æ¤¿ç”º", 
                    dates: "12/20-12/22", 
                    address: "æ„›çŸ¥ç¸£åå¤å±‹å¸‚ä¸­æ‘å€æ¤¿ç”º9-13 (ã€’453-0015)", 
                    phone: "+81-52-451-5489" 
                },
                { 
                    name: "MYSTAYS å¯Œå£«å±±å±•æœ›æ¸©æ³‰é…’åº—", 
                    dates: "12/22-12/24", 
                    address: "å±±æ¢¨ç¸£å¯Œå£«å‰ç”°å¸‚æ–°å€‰2654 (ã€’403-0011)", 
                    phone: "+81-555-21-7510" 
                },
                { 
                    name: "Land About Tokyo", 
                    dates: "12/24-12/28", 
                    address: "æ±äº¬éƒ½å°æ±å€æ ¹å²¸3-4-5 (ã€’110-0003)", 
                    phone: "+81-3-6802-4431" 
                }
            ],
            emergency: [
                { name: "æ—…å¤–åœ‹äººæ€¥é›£æ•‘åŠ©", phone: "+81-3-3280-7717" },
                { name: "å ±è­¦", phone: "110" },
                { name: "æ•‘è­·è»Š", phone: "119" }
            ],
            tickets: [
                { name: "Shibuya Sky å±•æœ›å°é–€ç¥¨", date: "12/25 (16:00~16:19)", type: "QR Code/PDF", link: "https://www.klook.com/zh-TW/activity/37777-shibuya-sky-tokyo/" }, 
                { name: "å¯Œå£«æ€¥æ¨‚åœ’é€šç¥¨", date: "12/23", type: "Barcode/Link", link: "https://www.fujiq.jp/en/ticket/index.html" },
                { name: "Harbs è›‹ç³•å…Œæ›åˆ¸", date: "12/20", type: "Image", link: "https://via.placeholder.com/150/0000FF/FFFFFF?text=Harbs+QR" }
            ]
        };

        const MAP_IMAGE_URL = 'https://raw.githubusercontent.com/sophie821004-alt/japan-trip-2025/main/tokyo_map.png'; 
        const THEME_COLOR = 'bg-[#FBF9F2]'; 
        const themeConfig = {
            city: { isDark: false, url: null, fallbackColor: THEME_COLOR },
            default: { isDark: false, url: null, fallbackColor: THEME_COLOR }
        };

        const getBackgroundStyle = (theme) => {
            const config = themeConfig[theme] || themeConfig.default;
            return {
                className: `theme-simple ${config.fallbackColor} transition-colors duration-500`,
                style: { backgroundColor: '#FBF9F2' },
                isDark: config.isDark 
            };
        };
        
        const MAP_BASE_URL = 'https://www.google.com/maps/search/';
        const createMapLink = (query) => MAP_BASE_URL + encodeURIComponent(query);
        
        const getWeatherIcon = (weather) => {
            switch (weather.toLowerCase()) {
                case 'sunny': return 'â˜€ï¸ æ™´å¤©';
                case 'cloudy': return 'â˜ï¸ å¤šé›²';
                case 'rain': return 'ğŸŒ§ï¸ é›¨å¤©';
                case 'snow': return 'â„ï¸ é›ªå¤©';
                default: return 'ğŸŒ¤ï¸';
            }
        };

        const formatTemperatures = (temperatures) => {
            return temperatures.map((t, index) => <span key={index} className="whitespace-nowrap">{t}Â°</span>)
                                .reduce((prev, curr) => [prev, <span key="separator" className="mx-1">/</span>, curr]);
        };

        const initialTripData = [
            // Day 1 (12/20) - åå¤å±‹æŠµé”
            {
                day: 1, date: "12/20 (Sat)", location: "Nagoya", weather: "sunny",
                temperature: [8, 10, 12, 14, 13, 11, 9, 8], 
                temp_hour_range: "10:00 - 18:00",
                daily_pass: "åéµå–®ç¨‹ç¥¨ (æ©Ÿå ´åˆ°é£¯åº—)", 
                memo: "Day 1 å‚™è¨»ï¼šè«‹ç¢ºä¿åéµç‰¹æ€¥è»Šç¥¨å·²è³¼è²·ã€‚**å‰›åˆ°æ—¥æœ¬å…ˆæ›å¥½ç¶²å¡ã€‚**", 
                events: [
                    { time: "09:00", title: "æ¡ƒåœ’ (TPE) âœˆï¸ åå¤å±‹ (NGO)", type: "transport", transport_note: "è™èˆª IT206 (è«‹è‡ªè¡Œç¢ºèªç™»æ©Ÿæ™‚é–“)", event_note: "Check-in & å‡ºå¢ƒ | D1 ç­æ©Ÿè³‡è¨Š", link: "" },
                    { time: "14:00-14:40", title: "æŠµé”NGO é€›è¡—", type: "leisure", transport_note: "", event_note: "æ©Ÿå ´é€›é€›", link: createMapLink('ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ æ–°ç‰¹éº—äº') },
                    { time: "14:40-15:00", title: "æ©Ÿå ´å°åƒ", type: "food", transport_note: "", event_note: "åœ¨æ©Ÿå ´ç°¡å–®åƒé»æ±è¥¿", link: createMapLink('ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ é¤å»³') },
                    { time: "15:00-15:50", title: "å‰å¾€é£¯åº—æ”¾è¡Œæ", type: "accommodation", transport_note: "VIA INN åå¤å±‹ç«™å‰æ¤¿ç”º", event_note: "ç‰¹æ€¥+èµ°è·¯ç´„ 40 åˆ†é˜ï¼Œæº–æ€¥+èµ°è·¯ç´„ 50 åˆ†é˜", link: createMapLink('VIA INN åå¤å±‹ç«™å‰æ¤¿ç”º') },
                    { time: "16:00-16:30", title: "å‰å¾€å¤§é ˆè§€éŸ³", type: "sight", transport_note: "åœ°éµ | å¤§é ˆè§€éŸ³ç«™", event_note: "é ç•™ 30 åˆ†é˜æŠ“å¯¶å¯å¤¢", link: createMapLink('å¤§é ˆè§€éŸ³') },
                    { time: "17:30-æ™šä¸Š", title: "å¤§é ˆè§€éŸ³ & å¤§é ˆå•†åº—è¡—", type: "shopping", transport_note: "åœ°éµ | å¤§é ˆè§€éŸ³ç«™", event_note: "å¤šæ•¸åº—å®¶ç‡Ÿæ¥­è‡³ 20:00", link: createMapLink('å¤§é ˆå•†åº—è¡—') },
                    { time: "æ™šé¤", title: "æ™šé¤ï¼šé°»é­šé£¯æˆ–å‘³å™Œè±¬æ’ (Op. 1 å¤©å©¦ç¾…è±¬æ’ å¤©å©¦ç¾…ç”ºæœ¬åº—)", type: "food", event_note: "è‹¥ D1 æ²’åƒåˆ° Harbs ç”œé»ï¼Œå¯åœ¨æ­¤æ™‚æ®µè£œåƒ", link: createMapLink('å¤©å©¦ç¾…ç”ºæœ¬åº— åå¤å±‹') },
                    { time: "æ™šä¸Š", title: "æ¦®å•†åœˆ / SKY-LE / UNIQLO GU", type: "shopping", event_note: "UNIQLO GU (~20:00), SKY-LE (~21:00)", link: createMapLink('æ¦®å•†åœˆ SKY-LE') },
                    { time: "æ™šä¸Š", title: "ç¶ æ´²21 æ‹ç…§ / åƒé‡Œé¦¬è—¥å±€", type: "leisure", transport_note: "", event_note: "ç¶ æ´² 21 æ‹å¤œæ™¯ï¼Œåƒé‡Œé¦¬è—¥å±€ç‡Ÿæ¥­è‡³ 22:00ï¼Œå›é£¯åº—æ™‚å¯ç¶“éé€›é€›", link: createMapLink('ç¶ æ´²21') }
                ]
            },
            // Day 2 (12/21) - å¤åŸæ–‡åŒ–ä¹‹æ—…
            {
                day: 2, date: "12/21 (Sun)", location: "Nagoya", weather: "cloudy",
                temperature: [7, 8, 10, 11, 10, 9, 8, 7], 
                temp_hour_range: "09:00 - 17:00",
                daily_pass: "åéµçŠ¬å±±ç‰¹æ€¥è»Šç¥¨", 
                memo: "Day 2 å‚™è¨»ï¼šä»Šå¤©å¤šåˆ©ç”¨åœ°éµã€‚å»ºè­°è³¼è²·åéµçŠ¬å±±ç‰¹æ€¥è»Šç¥¨ã€‚",
                events: [
                    { time: "07:00-07:30", title: "é£¯åº—æ—©é¤", type: "food", event_note: "é–‹æ”¾æ™‚é–“ 06:30-09:30", link: createMapLink('VIA INN åå¤å±‹ç«™å‰æ¤¿ç”º æ—©é¤') },
                    { time: "07:30-09:00", title: "å‰å¾€çŠ¬å±±åŸ", type: "transport", transport_note: "åéµçŠ¬å±±ç·š MuSKY (æ‰€æœ‰å¸­ä½å‡ç‚ºæŒ‡å®šå¸­)", event_note: "æ—©é»å‡ºç™¼é¿é–‹äººæ½®", link: createMapLink('çŠ¬å±±åŸ') },
                    { time: "09:00-10:00", title: "æ´—éŒ¢ / ä¸‰å…‰ç¨»è·ç¥ç¤¾", type: "sight", event_note: "ä¸‰å…‰ç¨»è·ç¥ç¤¾ (åœ¨çŠ¬å±±åŸè·¯ä¸Š)", link: createMapLink('ä¸‰å…‰ç¨»è·ç¥ç¤¾') },
                    { time: "10:00-12:00", title: "çŠ¬å±±åŸä¸‹ç”º", type: "sight", event_note: "é€›çŠ¬å±±åŸä¸‹ç”ºï¼Œå“åšç•¶åœ°å°åƒ", link: createMapLink('çŠ¬å±±åŸä¸‹ç”º') },
                    { time: "12:00-13:00", title: "åˆé¤ï¼šé£›é¨¨ç‰›ç‡’è‚‰å°ˆé–€åº— (è‚‰å…µè¡›æœ¬åº—æˆ–çŠ¬å±±å°ç´‹)", type: "food", event_note: "éœ€ç¢ºèªç‡Ÿæ¥­æ™‚é–“", link: createMapLink('è‚‰å…µè¡›æœ¬åº— çŠ¬å±±') },
                    { time: "13:00-14:30", title: "å‰å¾€åå¤å±‹åŸ", type: "transport", transport_note: "åéµå°ç‰§ç·š > ä¸Šé£¯ç”°ç«™ (ä¸æ›ä¹˜) > ä¸Šé£¯ç”°ç·š >å¹³å®‰é€šç«™ (æ›ä¹˜) > ååŸç·š > åå¤å±‹åŸç«™", event_note: "æ³¨æ„åå¤å±‹åŸçš„äº¤é€šè½‰æ›", link: createMapLink('åå¤å±‹åŸ') },
                    { time: "14:30-16:00", title: "åå¤å±‹åŸ", type: "sight", event_note: "äº¤é€šåˆ¸æ›å…¥å ´åˆ¸ï¼Œæ³¨æ„é—œé–€æ™‚é–“ (16:30)", link: createMapLink('åå¤å±‹åŸ') },
                    { time: "16:30-18:00", title: "æ™šé¤ / åéµç™¾è²¨å•†åœˆ", type: "food", event_note: "è‹¥ D1 æ²’åƒåˆ°é°»é­šé£¯çš„è©±å¯æ­¤æ™‚æ®µåƒ", link: createMapLink('åéµç™¾è²¨æœ¬åº—') },
                    { time: "æ™šä¸Š", title: "UNIQLO / BicCamera / åƒé‡Œé¦¬è—¥å±€", type: "shopping", event_note: "BicCamera åå¤å±‹è»Šç«™åº—è¥¿åº— / JR TOWER åº— ç‡Ÿæ¥­ (~21:00)ï¼Œåƒé‡Œé¦¬è—¥å±€ç‡Ÿæ¥­è‡³ 22:00", link: createMapLink('åƒé‡Œé¦¬è—¥å±€ åå¤å±‹ç«™') }
                ]
            },
            // Day 3 (12/22) - æ—©ä¸Šç†±ç”°ç¥å®® & ä¸­åˆå‰å¾€å¯Œå£«å±± ğŸ—»
            {
                day: 3, date: "12/22 (Mon)", location: "Fuji", weather: "rain",
                temperature: [5, 7, 9, 10, 8, 7, 6, 5], 
                temp_hour_range: "08:00 - 16:00",
                daily_pass: "JR é«˜é€Ÿå·´å£« (åå¤å±‹ -> å¯Œå£«æ€¥æ¨‚åœ’)", 
                memo: "Day 3 å‚™è¨»ï¼šå‹™å¿…ç¢ºèªé»‘è²“å®…æ€¥ä¾¿å¯„ä»¶ã€‚",
                events: [
                    { time: "08:00", title: "Check-out & è¡Œæå¯„é€", type: "accommodation", event_note: "å°‡å¤§ä»¶è¡Œæå¯„é€åˆ°æ±äº¬ Land About Tokyo (é»‘è²“å®…æ€¥ä¾¿)", link: createMapLink('é»‘è²“å®…æ€¥ä¾¿ åå¤å±‹è»Šç«™') },
                    { time: "09:00", title: "ç†±ç”°ç¥å®®", type: "sight", transport_note: "åéµæˆ–åœ°éµ (ç¥å®®è¥¿ç«™)", event_note: "åƒæ‹œå¾Œéœ€é ç•™æ™‚é–“è¿”å›è»Šç«™", link: createMapLink('ç†±ç”°ç¥å®®') },
                    { time: "11:00", title: "åˆé¤ï¼šåå¤å±‹ç«™é™„è¿‘å¿«é€Ÿç”¨é¤", type: "food", event_note: "åœ¨è»Šç«™å‘¨é‚Šå¿«é€Ÿè§£æ±ºåˆé¤ï¼Œæº–å‚™æ­è»Š", link: createMapLink('åå¤å±‹è»Šç«™å‘¨é‚Šåˆé¤') },
                    { time: "12:00", title: "é«˜é€Ÿå·´å£«ï¼šåå¤å±‹ -> å¯Œå£«æ€¥æ¨‚åœ’", type: "transport", transport_note: "JR æ±æµ·é«˜é€Ÿå·´å£« | è»Šç¨‹ç´„ 4.5hrã€‚", event_note: "å·´å£«æ™‚é–“å·²èª¿æ•´è‡³ä¸­åˆã€‚å¸¶é»é›¶é£Ÿå’Œæ°´ã€‚", link: "https://www.japan-guide.com/bus/fuji.html" },
                    { time: "16:30", title: "æŠµé”å¯Œå£«æ€¥æ¨‚åœ’ç«™", type: "transport", event_note: "è½‰ä¹˜è‡³é£¯åº— (å¯èƒ½éœ€æ­ä¹˜è¨ˆç¨‹è»Šæˆ–æ¥é§è»Š)", link: createMapLink('å¯Œå£«æ€¥æ¨‚åœ’ç«™') },
                    { time: "17:30", title: "MYSTAYS å¯Œå£«å±±å±•æœ›æº«æ³‰é…’åº— Check-in", type: "accommodation", event_note: "ç¢ºèªæˆ¿é–“çš„å¯Œå£«å±±æ™¯è§€ï¼", link: createMapLink('MYSTAYS å¯Œå£«å±±å±•æœ›æº«æ³‰é…’åº—') },
                    { time: "20:00", title: "æ™šé¤ï¼šé£¯åº—é™„è¿‘æˆ–æº«æ³‰è¨­æ–½ç”¨é¤", type: "food", event_note: "é£¯åº—æº«æ³‰è¨­æ–½æˆ–é™„è¿‘å±…é…’å±‹", link: createMapLink('å¯Œå£«å‰ç”° æ™šé¤') },
                    { time: "21:30", title: "é«”é©—é£¯åº—æº«æ³‰", type: "leisure", event_note: "", link: createMapLink('MYSTAYS å¯Œå£«å±±å±•æœ›æº«æ³‰é…’åº— æº«æ³‰') }
                ]
            },
            // Day 4 (12/23) - å¯Œå£«æ€¥æ¨‚åœ’ ğŸ¢
            { 
                day: 4, date: "12/23 (Tue)", location: "Fuji-Q Highland", weather: "sunny", 
                temperature: [2, 5, 8, 10, 9, 7, 5, 3], 
                temp_hour_range: "09:00 - 17:00", 
                daily_pass: "å¯Œå£«æ€¥æ¨‚åœ’é€šç¥¨", 
                memo: "è«‹å‚™å¦¥é˜²å¯’è¡£ç‰©ï¼Œå±±å€æ°£æº«è¼ƒä½ã€‚å»ºè­°å…ˆç©é«˜äººæ°£çš„é›²éœ„é£›è»Šã€‚", 
                events: [
                    { time: "09:00", title: "å¯Œå£«æ€¥æ¨‚åœ’ é–‹åœ’", type: "amusement", event_note: "ä½¿ç”¨é€šç¥¨å…¥åœ’ï¼Œå»ºè­°å…ˆæ’éšŠç©é«˜é£›è»Šæˆ–ãˆãˆã˜ã‚ƒãªã„ã‹", link: toolsData.tickets[1].link },
                    { time: "12:30", title: "åˆé¤ï¼šæ¨‚åœ’å…§é¤å»³", type: "food", event_note: "åœ¨åœ’å€å…§é¸æ“‡å–œæ­¡çš„ä¸»é¡Œé¤å»³", link: createMapLink('å¯Œå£«æ€¥æ¨‚åœ’ é¤å»³') },
                    { time: "15:00", title: "é¬¼å±‹æˆ°æ…„è¿·å®® / å…¶ä»–è¨­æ–½", type: "amusement", event_note: "æŒ‘æˆ°ä¸–ç•Œæœ€é•·æœ€å¯æ€•çš„é¬¼å±‹ï¼", link: createMapLink('å¯Œå£«æ€¥æ¨‚åœ’ æˆ°æ…„è¿·å®®') },
                    { time: "18:00", title: "æ™šé¤ï¼šæ²³å£æ¹–è»Šç«™é™„è¿‘", type: "food", event_note: "å˜—è©¦ç•¶åœ°çš„é¤ºé£¥éºµ (ã»ã†ã¨ã†) æˆ–ç‡’è‚‰", link: createMapLink('æ²³å£æ¹–è»Šç«™ æ™šé¤') },
                    { time: "20:00", title: "è¿”å›é£¯åº—ä¼‘æ¯ / æº«æ³‰", type: "leisure", event_note: "", link: createMapLink('MYSTAYS å¯Œå£«å±±å±•æœ›æº«æ³‰é…’åº—') }
                ]
            },
            // Day 5 (12/24) - æ²³å£æ¹–è§€å…‰ & å‚æ™šå‰å¾€æ±äº¬ & æ™šä¸Šæ™´ç©ºå¡” ğŸ„
            { 
                day: 5, date: "12/24 (Wed)", location: "Tokyo / Travel Day", weather: "cloudy", 
                temperature: [6, 8, 11, 13, 12, 10, 8, 7], 
                temp_hour_range: "10:00 - 18:00", 
                daily_pass: "å¯Œå£«å±±å‘¨éŠå·´å£« + é«˜é€Ÿå·´å£« (æ²³å£æ¹– -> æ±äº¬)", 
                memo: "ä¸Šåˆå°ˆæ³¨æ–¼å¯Œå£«å±±å‘¨é‚Šè§€å…‰ã€‚ä¸‹åˆæ­ä¹˜æ™šç­å·´å£«å‰å¾€æ±äº¬ã€‚è«‹æå‰ç¢ºèªå·´å£«ç¥¨ã€‚", 
                events: [
                    { time: "09:00", title: "Check-out & å¯„æ”¾è¡Œæ", type: "accommodation", event_note: "è¾¦ç†é€€æˆ¿æ‰‹çºŒï¼Œå°‡è¡Œæå¯„æ”¾åœ¨é£¯åº—æ«ƒå°æˆ–è»Šç«™ç½®ç‰©æ«ƒ", link: createMapLink('æ²³å£æ¹–è»Šç«™ è¡Œæå¯„æ”¾') },
                    { time: "09:30", title: "æ²³å£æ¹–å¤©ä¸Šå±±å…¬åœ’ (Kachi Kachi å±±çºœè»Š)", type: "sight", transport_note: "æ²³å£æ¹–å‘¨éŠå·´å£« (ç´…ç·š)", event_note: "æ¬£è³æ²³å£æ¹–å…¨æ™¯èˆ‡å¯Œå£«å±±", link: createMapLink('æ²³å£æ¹–å¤©ä¸Šå±±å…¬åœ’ çºœè»Š') },
                    { time: "11:30", title: "æ–°å€‰å±±æ·ºé–“å…¬åœ’", type: "sight", transport_note: "å¯Œå£«æ€¥è¡Œç·šä¸‹å‰ç”°ç«™", event_note: "çˆ¬ä¸Šå¿ éˆå¡”æ‹æ”å¯Œå£«å±±ç¶“å…¸ç…§", link: createMapLink('æ–°å€‰å±±æ·ºé–“å…¬åœ’') },
                    { time: "13:30", title: "åˆé¤ï¼šæ²³å£æ¹–å‘¨é‚Šé¤å»³", type: "food", event_note: "å»ºè­°åœ¨æ²³å£æ¹–è»Šç«™é™„è¿‘ç”¨é¤", link: createMapLink('æ²³å£æ¹–åˆé¤æ¨è–¦') },
                    { time: "16:30", title: "é«˜é€Ÿå·´å£«ï¼šæ²³å£æ¹– -> æ–°å®¿/æ±äº¬ç«™", type: "transport", transport_note: "å·´å£«ç´„ 17:00 å‡ºç™¼ | è»Šç¨‹ç´„ 2 å°æ™‚", event_note: "æ­ä¹˜é è¨‚çš„å·´å£«å‰å¾€æ±äº¬", link: "https://www.highwaybus.com/gp/reservation/rsvPlanList?routeGroupNo=1&routeNo=111&displayType=4" },
                    { time: "19:30", title: "æŠµé”æ–°å®¿ / å‰å¾€é£¯åº— Land About Tokyo Check-in", type: "accommodation", transport_note: "åœ°éµæˆ–JRè‡³æ—¥æš®é‡Œç«™", event_note: "æ–¼æ—…é¤¨ Land About Tokyo Check-inï¼Œé ˜å–è¡Œæ", link: createMapLink('Land About Tokyo') },
                    { time: "21:00", title: "æ™šé¤ï¼šä¸Šé‡/æ—¥æš®é‡Œé™„è¿‘", type: "food", event_note: "åœ¨é£¯åº—é™„è¿‘å¿«é€Ÿç”¨é¤", link: createMapLink('æ—¥æš®é‡Œ æ™šé¤') },
                    { time: "22:00", title: "æ™´ç©ºå¡”è–èª•æ´»å‹• / å…­æœ¬æœ¨é»ç‡ˆ (äºŒé¸ä¸€)", type: "sight", event_note: "é¸æ“‡å…¶ä¸­ä¸€å€‹é»ç‡ˆæ´»å‹•ï¼Œæ¬£è³è–èª•å¤œæ™¯", link: createMapLink('æ±äº¬ å…­æœ¬æœ¨ä¹‹ä¸˜ é»ç‡ˆ') }
                ]
            },
            // Day 6 (12/25) - æ¾€è°·èˆ‡åŸå®¿ & æ™šä¸Šå…­æœ¬æœ¨é»ç‡ˆ ğŸ„ 
            { 
                day: 6, date: "12/25 (Thu)", location: "Tokyo Shibuya", weather: "sunny", 
                temperature: [7, 9, 12, 14, 13, 11, 9, 8], 
                temp_hour_range: "11:00 - 19:00", 
                daily_pass: "æ±äº¬åœ°éµä¸€æ—¥åˆ¸", 
                memo: "è–èª•ç¯€ç•¶å¤©äººæ½®çœ¾å¤šã€‚å‹™å¿…æ³¨æ„ Shibuya Sky çš„é ç´„æ™‚é–“ (16:00~16:19)ã€‚", 
                events: [
                    { time: "07:30-08:00", title: "é£¯åº—æ—©é¤ (Land About Tokyo)", type: "food", event_note: "é–‹æ”¾æ™‚é–“ 07:00-10:00 ä¹‹é–“", link: createMapLink('Land About Tokyo æ—©é¤') },
                    { time: "10:00", title: "æ˜æ²»ç¥å®®", type: "sight", transport_note: "åœ°éµè‡³ä»£ä»£æœ¨ç«™/åŸå®¿ç«™", event_note: "æ—¥æœ¬æœ€é‡è¦çš„ç¥ç¤¾ä¹‹ä¸€", link: createMapLink('æ˜æ²»ç¥å®®') },
                    { time: "åˆé¤", title: "åˆé¤ï¼šæ¥µå‘³å±‹ æ¾€è°· PARCO åº—", type: "food", transport_note: "æ¾€è°· PARCO B1", event_note: "è‘—åçš„æ¼¢å ¡æ’ï¼Œå»ºè­°ææ—©å‰å¾€æ’éšŠã€‚", link: createMapLink('æ¥µå‘³å±‹ æ¾€è°· PARCO åº—') }, 
                    { time: "14:00", title: "æ¾€è°·é€›è¡—è³¼ç‰©", type: "shopping", event_note: "æ¾€è°· PARCO/é‹å‹•ç”¨å“åº—ç­‰ï¼Œä¸¦æ­¥è¡Œè‡³ Shibuya Sky", link: createMapLink('æ¾€è°·é€›è¡—è³¼ç‰©') },
                    { time: "16:00-17:30", title: "æ¾€è°· Sky å±•æœ›å°", type: "sight", event_note: "é ç´„æ™‚é–“ç‚º 16:00~16:19ï¼Œå‹™å¿…æº–æ™‚æŠµé”ï¼Œè§€è³å¤•é™½èˆ‡å¤œæ™¯ã€‚", link: toolsData.tickets[0].link }, 
                    { time: "18:00", title: "é’ä¹‹æ´çªŸ", type: "sight", event_note: "å†¬å­£é™å®šç‡ˆé£¾æ´»å‹• (é€šå¸¸åœ¨æ¾€è°·èˆ‰è¡Œ)", link: createMapLink('é’ä¹‹æ´çªŸ æ¾€è°·') },
                    { time: "æ™šé¤", title: "æ™šé¤ï¼šSteak Rice & Curry Restaurant", type: "food", event_note: "æ‚¨æŒ‡å®šçš„é¤å»³", link: createMapLink('æ±äº¬ Steak Rice & Curry Restaurant') },
                    { time: "æ™šä¸Š", title: "å…­æœ¬æœ¨ä¹‹ä¸˜è–èª•é»ç‡ˆ (Roppongi Illumination)", type: "sight", transport_note: "åœ°éµè‡³å…­æœ¬æœ¨ç«™", event_note: "æ¬£è³è¯éº—çš„æ«¸æœ¨å‚å¤§é“é»ç‡ˆ", link: createMapLink('å…­æœ¬æœ¨ä¹‹ä¸˜') }
                ]
            },
            // Day 7 (12/26) - æ·ºè‰ã€æ™´ç©ºå¡”èˆ‡æŠ¼ä¸Šæº«æ³‰ â›©ï¸
            { 
                day: 7, date: "12/26 (Fri)", location: "Tokyo Asakusa", weather: "cloudy", 
                temperature: [8, 10, 12, 13, 12, 11, 10, 9], 
                temp_hour_range: "10:00 - 18:00", 
                daily_pass: "æ±äº¬åœ°éµä¸€æ—¥åˆ¸", 
                memo: "Day 7 å‚™è¨»ï¼šä¸»è¦åœ¨æ·ºè‰/æŠ¼ä¸Šå‘¨é‚Šæ´»å‹•ï¼Œå¯å¤šåˆ©ç”¨åœ°éµã€‚", 
                events: [
                    { time: "07:30-08:00", title: "é£¯åº—æ—©é¤ (Land About Tokyo)", type: "food", event_note: "é–‹æ”¾æ™‚é–“ 07:00-10:00 ä¹‹é–“", link: createMapLink('Land About Tokyo æ—©é¤') },
                    { time: "10:00", title: "æ·ºè‰å¯º (Sensoji Temple) & é›·é–€", type: "sight", transport_note: "åœ°éµè‡³æ·ºè‰ç«™", event_note: "åƒè§€é›·é–€ã€ä»²è¦‹ä¸–é€šï¼ŒæŠ½ç±¤æ±‚é‹å‹¢", link: createMapLink('æ·ºè‰å¯º é›·é–€') },
                    { time: "åˆé¤", title: "åˆé¤ï¼šæ·ºè‰ä»ŠåŠ (å£½å–œç‡’/ä¾¿å®œåˆé¤)", type: "food", event_note: "å¹³æ—¥ä¸­åˆä¾¿å®œå¾ˆå¤šï¼Œç´„ä¸€äºº 1000 å°å¹£å·¦å³", link: createMapLink('æ·ºè‰ä»ŠåŠ') },
                    { time: "15:00", title: "æ™´ç©ºå¡” (Tokyo Skytree) & Pokemon Center", type: "shopping", transport_note: "åœ°éµè‡³æŠ¼ä¸Šç«™", event_note: "ç™»å¡”è§€æ™¯æˆ–åœ¨å‘¨é‚Šçš„ Solamachi è³¼ç‰©ï¼Œå°‹æ‰¾ Pokemon Center", link: createMapLink('æ±äº¬æ™´ç©ºå¡” Pokemon Center') },
                    { time: "18:00", title: "æŠ¼ä¸Šå¤©ç„¶æº«æ³‰ å¤§é»‘æ¹¯", type: "leisure", transport_note: "è¿‘æŠ¼ä¸Šç«™ (Oshiage)", event_note: "é«”é©—æ—¥å¼æº«æ³‰ï¼Œæ”¾é¬†èº«å¿ƒ", link: createMapLink('æŠ¼ä¸Šå¤©ç„¶æº«æ³‰ å¤§é»‘æ¹¯') },
                    { time: "æ™šé¤", title: "æ™šé¤ï¼šæº«æ³‰å‘¨é‚Šæˆ–è¿”å›ä¸Šé‡", type: "food", event_note: "äº«ç”¨æ™šé¤å¾Œè¿”å›é£¯åº—", link: createMapLink('æŠ¼ä¸Š æ™šé¤æ¨è–¦') }
                ]
            },
            // Day 8 (12/27) - æ–°å¢ç¥ç”°ç¥å®®/å°ç¶²ç¥ç¤¾/äººå½¢ç”º 
            { 
                day: 8, date: "12/27 (Sat)", location: "Tokyo Kanda & Shinonome", weather: "sunny", 
                temperature: [7, 9, 11, 13, 12, 10, 8, 7], 
                temp_hour_range: "10:00 - 18:00", 
                daily_pass: "æ±äº¬åœ°éµä¸€æ—¥åˆ¸", 
                memo: "Day 8 å‚™è¨»ï¼šå…ˆåƒæ‹œç¥ç¤¾ï¼Œä¸‹åˆå‰å¾€æ±é›²Ricolandã€‚æ™šä¸Šåœ¨ä¸Šé‡å‘¨é‚Šé€²è¡Œæœ€å¾Œæ¡è²·ã€‚", 
                events: [
                    { time: "07:30-08:00", title: "é£¯åº—æ—©é¤ (Land About Tokyo)", type: "food", event_note: "é–‹æ”¾æ™‚é–“ 07:00-10:00 ä¹‹é–“", link: createMapLink('Land About Tokyo æ—©é¤') },
                    { time: "10:00", title: "ç¥ç”°æ˜ç¥ (Kanda Myojin Shrine)", type: "sight", transport_note: "JR/åœ°éµè‡³ç§‹è‘‰åŸç«™æˆ–å¾¡èŒ¶æ°´ç«™", event_note: "åƒæ‹œä¿ä½‘äº‹æ¥­ã€å‹åˆ©ã€å§»ç·£", link: createMapLink('ç¥ç”°æ˜ç¥') },
                    { time: "11:30", title: "å°ç¶²ç¥ç¤¾ (Koami Shrine)", type: "sight", transport_note: "åœ°éµè‡³äººå½¢ç”ºç«™/æ°´å¤©å®®å‰ç«™", event_note: "æ±‚è²¡é‹èˆ‡æ¶ˆç½è§£å„ï¼Œå¯æ´—éŒ¢", link: createMapLink('å°ç¶²ç¥ç¤¾') },
                    { time: "13:00", title: "åˆé¤ï¼šäººå½¢ç”ºå‘¨é‚Š (è‡ªç”±é¸æ“‡)", type: "food", event_note: "äººå½¢ç”ºå¤šæ—¥å¼å‚³çµ±é¤å»³ï¼Œå»ºè­°æå‰å°‹æ‰¾ç›®æ¨™", link: createMapLink('äººå½¢ç”º åˆé¤æ¨è–¦') },
                    { time: "15:00", title: "Ricoland Tokyo Bay", type: "shopping", transport_note: "åœ°éµè‡³æ±é›²ç«™ (Shinonome)", event_note: "æ‘©æ‰˜è»Šç”¨å“åº—ï¼Œæ¡è³¼æ™‚é–“è¼ƒ...", link: createMapLink('Ricoland Tokyo Bay') },
                    { time: "18:00", title: "æ™šé¤ï¼šä¸Šé‡/å¾¡å¾’ç”ºé™„è¿‘", type: "food", event_note: "ç”¨é¤å¾Œè¿”å›é£¯åº—å‘¨é‚Š", link: createMapLink('ä¸Šé‡/å¾¡å¾’ç”ºæ™šé¤æ¨è–¦') },
                    { time: "æ™šä¸Š", title: "ä¸Šé‡é€›è¡—è³¼ç‰© (è—¥å¦/é›¶é£Ÿ)", type: "shopping", event_note: "åœ¨ä¸Šé‡é˜¿ç¾æ©«ç”ºæˆ–è»Šç«™å‘¨é‚Šé€²è¡Œæœ€å¾Œçš„æ¡è²·ã€‚", link: createMapLink('ä¸Šé‡ é˜¿ç¾æ©«ç”º') }, 
                    { time: "æ™šä¸Š", title: "è¿”å›é£¯åº—æ•´ç†è¡Œæ", type: "accommodation", event_note: "æ‰“åŒ…è³¼è²·çš„å•†å“ï¼Œæº–å‚™éš”æ—¥Check-out", link: createMapLink('Land About Tokyo') }
                ]
            },
            // Day 9 (12/28) - é£¯åº—Check-out & æˆç”°æ©Ÿå ´å›ç¨‹ âœˆï¸
            { 
                day: 9, date: "12/28 (Sun)", location: "Narita / Departure", weather: "sunny", 
                temperature: [5, 7, 10, 12, 11, 9, 7, 5], 
                temp_hour_range: "09:00 - 17:00", 
                daily_pass: "Skyliner/N'EX å¾€æˆç”°æ©Ÿå ´", 
                memo: "Day 9 å‚™è¨»ï¼šè«‹ææ—©å‰å¾€æˆç”°æ©Ÿå ´ï¼Œé ç•™ Check-in èˆ‡è³¼ç‰©æ™‚é–“ã€‚", 
                events: [
                    { time: "07:30-08:00", title: "é£¯åº—æ—©é¤ (Land About Tokyo)", type: "food", event_note: "é–‹æ”¾æ™‚é–“ 07:00-10:00 ä¹‹é–“", link: createMapLink('Land About Tokyo æ—©é¤') },
                    { time: "10:00", title: "Check-out & å‰å¾€æ©Ÿå ´", type: "transport", transport_note: "JR/Skyliner/N'EX è‡³æˆç”°æ©Ÿå ´ (NRT)", event_note: "å‹™å¿…é ç•™è‡³å°‘ 2.5 å°æ™‚äº¤é€šæ™‚é–“", link: createMapLink('æˆç”°æ©Ÿå ´ NRT') },
                    { time: "13:00", title: "æˆç”°æ©Ÿå ´ Check-in", type: "transport", transport_note: "æ¨‚æ¡ƒèˆªç©ºæ«ƒå° (MM625)", event_note: "é ç•™æ™‚é–“è¾¦ç†ç™»æ©Ÿèˆ‡è¨—é‹", link: createMapLink('æˆç”°æ©Ÿå ´T1 æ¨‚æ¡ƒæ«ƒå°') },
                    { time: "14:00", title: "åˆé¤èˆ‡æ©Ÿå ´å…ç¨…è³¼ç‰©", type: "shopping", event_note: "åœ¨æ©Ÿå ´å…§äº«ç”¨æœ€å¾Œçš„æ—¥å¼é¤é»ä¸¦æ¡è²·ä¼´æ‰‹ç¦®", link: createMapLink('æˆç”°æ©Ÿå ´T1 å…ç¨…åº—') },
                    { time: "16:35", title: "æˆç”° (NRT) âœˆï¸ æ¡ƒåœ’ (TPE)", type: "transport", transport_note: "æ¨‚æ¡ƒ MM625", event_note: "ç™»æ©Ÿèˆ‡å•Ÿç¨‹å›åœ‹", link: "" }
                ]
            } 
        ];


        // ====================================================================
        // START: Firebase é›²ç«¯è¨˜å¸³é‚è¼¯ (å·²ä¿®æ”¹)
        // ====================================================================
        
        const SplitTool = ({ notes, setNotes }) => {
            const [expenses, setExpenses] = useState([]);
            const [isFirebaseLoaded, setIsFirebaseLoaded] = useState(false);
            const unsubscribeRef = useRef(null);
            const updateTimeoutRef = useRef({}); 
            
            // --- åŒ¯ç‡è‡ªå‹•æ›´æ–° ---
            const [exchangeRate, setExchangeRate] = useLocalStorageState('exchangeRate', 0.22); 
            const [isFetchingRate, setIsFetchingRate] = useState(true); 
            const [fetchError, setFetchError] = useState(null);
            // -----------------------------

            // åˆå§‹åŒ–ã€ç›£è½ Firebase è³‡æ–™ & è‡ªå‹•æŠ“å–åŒ¯ç‡
            useEffect(() => {
                // 1. Firebase ç›£è½ 
                if (db) {
                    unsubscribeRef.current = db.collection("expenses")
                        .orderBy("timestamp", "asc") 
                        .onSnapshot((snapshot) => {
                            const fetchedExpenses = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data(),
                                amount: parseInt(doc.data().amount) || 0 
                            }));
                            setExpenses(fetchedExpenses);
                            setIsFirebaseLoaded(true);
                        }, (error) => {
                            console.error("Error listening to expenses:", error);
                            // å³ä½¿å¤±æ•—ï¼Œä¹Ÿé¡¯ç¤ºè³‡æ–™è¼‰å…¥å®Œæˆï¼Œé¿å…ä¸€ç›´é¡¯ç¤ºè®€å–ä¸­
                            setIsFirebaseLoaded(true); 
                        });

                    db.collection("config").doc("notes").get().then(doc => {
                        if (doc.exists) setNotes(doc.data().content);
                    }).catch(error => console.error("Error fetching notes:", error));
                }
                
                // 2. è‡ªå‹•æŠ“å–åŒ¯ç‡ (æ–°å¢)
                const fetchExchangeRate = async () => {
                    const API_URL = 'https://api.exchangerate.host/latest?base=JPY&symbols=TWD'; 

                    setIsFetchingRate(true);
                    setFetchError(null);

                    try {
                        const response = await fetch(API_URL);
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        const data = await response.json();

                        const jpyToTwdRate = data.rates.TWD;
                        
                        if (jpyToTwdRate && jpyToTwdRate > 0) {
                            const newRate = parseFloat(jpyToTwdRate.toFixed(4));
                            
                            if (newRate >= 0.18 && newRate <= 0.28) { 
                                setExchangeRate(newRate);
                                setFetchError(null); 
                            } else {
                                throw new Error(`Fetched rate (${newRate}) seems incorrect or out of bounds.`);
                            }
                        } else {
                            throw new Error("API response is missing TWD rate.");
                        }

                    } catch (error) {
                        console.error("Failed to fetch exchange rate:", error);
                        setFetchError(`è‡ªå‹•æ›´æ–°å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜åŒ¯ç‡ (${exchangeRate})ã€‚`);
                    } finally {
                        setIsFetchingRate(false);
                    }
                };
                
                fetchExchangeRate();

                // çµ„ä»¶å¸è¼‰æ™‚å–æ¶ˆç›£è½
                return () => {
                    if (unsubscribeRef.current) unsubscribeRef.current();
                };
            }, []); 
            
            // æ–°å¢è²»ç”¨ (å·²ä¿®æ­£ timestamp éŒ¯èª¤)
            const addExpense = async () => {
                if (!db) return alert("Firebase æœªé€£æ¥");
                try {
                    const newDocRef = db.collection("expenses").doc();
                    
                    const newExpense = {
                        name: 'æ–°çš„è²»ç”¨é …ç›®',
                        amount: 0,
                        paidBy: TRAVELERS[0],
                        // ä½¿ç”¨ Date.now() æ›¿ä»£ serverTimestamp() è§£æ±ºå…¼å®¹æ€§å•é¡Œ
                        timestamp: Date.now() 
                    };

                    await newDocRef.set(newExpense);
                    
                } catch (error) {
                    console.error("Error adding expense:", error);
                    alert("æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™");
                }
            };

            // æ›´æ–°è²»ç”¨ (Debounce é˜²æŠ–å‹•å¯«å…¥)
            const handleExpenseChange = (id, field, value) => {
                setExpenses(prev => prev.map(exp => 
                    exp.id === id ? { ...exp, [field]: value } : exp
                ));

                const timerKey = `${id}-${field}`;
                if (updateTimeoutRef.current[timerKey]) {
                    clearTimeout(updateTimeoutRef.current[timerKey]);
                }

                updateTimeoutRef.current[timerKey] = setTimeout(async () => {
                    if (!db) return;
                    try {
                        if (value !== undefined) {
                            // ä¿®æ­£ï¼šFirebase å¯«å…¥æ™‚ï¼Œamount å¿…é ˆæ˜¯ Number é¡å‹
                            const updateValue = field === 'amount' ? parseInt(value) || 0 : value;
                            await db.collection("expenses").doc(id).update({
                                [field]: updateValue
                            });
                        }
                    } catch (error) {
                        console.error(`Error updating expense ${id}:`, error);
                    }
                }, 500);
            };

            // åˆªé™¤è²»ç”¨
            const removeExpense = async (id) => {
                if (!confirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ")) return;
                if (!db) return;
                try {
                    await db.collection("expenses").doc(id).delete();
                } catch (error) {
                    console.error("Error deleting expense:", error);
                }
            };
            
            // å‚™è¨»å„²å­˜ (Debounce)
            const handleNotesChange = (e) => {
                const val = e.target.value;
                setNotes(val);
                
                if(window.noteTimer) clearTimeout(window.noteTimer);
                
                window.noteTimer = setTimeout(() => {
                    if(db) {
                        db.collection("config").doc("notes").set({ content: val });
                    }
                }, 1000);
            };

            // è¨ˆç®—é‚è¼¯
            const calculations = useMemo(() => {
                const totalJPY = expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const totalTWD = (totalJPY * exchangeRate).toFixed(0);
                const halfJPY = totalJPY / TRAVELERS.length;
                
                const paidTotals = TRAVELERS.reduce((acc, traveler) => ({ ...acc, [traveler]: 0 }), {});
                expenses.forEach(exp => {
                    if(paidTotals[exp.paidBy] !== undefined) {
                        paidTotals[exp.paidBy] += exp.amount;
                    }
                });
                
                const settlement = TRAVELERS.map(traveler => {
                    const paid = paidTotals[traveler];
                    const diff = paid - halfJPY; 
                    return { traveler, paid, diff, diffTWD: (diff * exchangeRate).toFixed(0) };
                });
                
                const giver = settlement.find(s => s.diff < 0);
                const receiver = settlement.find(s => s.diff > 0);
                
                let msg = "æ”¯å‡ºå·²å¹³è¡¡ã€‚";
                if (giver && receiver) {
                    const jpy = Math.abs(giver.diff).toLocaleString(undefined, { maximumFractionDigits: 0 });
                    const twd = Math.abs(giver.diffTWD).toLocaleString();
                    msg = `${giver.traveler} æ‡‰è½‰å¸³çµ¦ ${receiver.traveler}ï¼š${jpy} JPY (ç´„ ${twd} TWD)`;
                }
                return { totalJPY, totalTWD, settlementMessage: msg };
            }, [expenses, exchangeRate]);

            const { totalJPY, totalTWD, settlementMessage } = calculations;

            return (
                <div className="p-4 pt-6 pb-20 bg-white min-h-screen">
                    <h1 className="text-3xl font-extrabold text-gray-900 mb-6">ğŸ’° é›²ç«¯åˆ†å¸³å·¥å…·</h1>
                    <div className={`border-l-4 p-3 mb-4 text-sm font-medium ${isFirebaseLoaded ? 'bg-green-100 border-green-500 text-green-800' : 'bg-red-100 border-red-500 text-red-800'}`}>
                        {isFirebaseLoaded ? 'âœ… å·²é€£ç·š Firebaseï¼Œè³‡æ–™è‡ªå‹•åŒæ­¥ã€‚' : 'âš ï¸ é€£ç·šä¸­æˆ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™ã€‚'}
                    </div>

                    {/* åŒ¯ç‡è¨­å®š (å·²åŠ å…¥è‡ªå‹•æ›´æ–°ç‹€æ…‹é¡¯ç¤º) */}
                    <div className="bg-indigo-50 p-4 rounded-lg shadow-md mb-6">
                        <div className="flex items-center justify-between">
                            <span className="font-bold text-indigo-800">åŒ¯ç‡ (JPYâ†’TWD)</span>
                            <div className="relative">
                                <input 
                                    type="number" 
                                    value={exchangeRate} 
                                    onChange={e => setExchangeRate(parseFloat(e.target.value)||0)} 
                                    className="expense-input w-24 pr-8" 
                                    step="0.0001" 
                                    min="0"
                                    // æŠ“å–ä¸­æ™‚ç¦ç”¨æ‰‹å‹•è¼¸å…¥ï¼Œé™¤éæœ‰éŒ¯èª¤ç™¼ç”Ÿ
                                    disabled={isFetchingRate && fetchError === null} 
                                />
                                <span className="absolute right-2 top-1/2 transform -translate-y-1/2 text-xs text-gray-500">TWD</span>
                            </div>
                        </div>
                        <div className="mt-2 text-xs text-center">
                            {isFetchingRate && <span className="text-indigo-600">ğŸŒ æ­£åœ¨è‡ªå‹•æ›´æ–°åŒ¯ç‡...</span>}
                            {fetchError && <span className="text-red-500">{fetchError} <span className="text-gray-600">æ‚¨å¯ä»¥æ‰‹å‹•èª¿æ•´ã€‚</span></span>}
                            {(!isFetchingRate && fetchError === null) && <span className="text-green-600 font-semibold">âœ… åŒ¯ç‡å·²è‡ªå‹•æ›´æ–°ï¼ (1 JPY â‰ˆ {exchangeRate} TWD)</span>}
                        </div>
                    </div>

                    {/* çµç®—å¡ç‰‡ */}
                    <div className="bg-green-100 p-4 rounded-lg shadow-lg mb-8">
                        <h3 className="text-xl font-bold text-green-800 mb-3">ç¸½çµç®—</h3>
                        <div className="flex justify-between mb-1"><span>ç¸½æ”¯å‡º (JPY)</span><span className="font-bold">{totalJPY.toLocaleString()}</span></div>
                        <div className="flex justify-between mb-3"><span>ç¸½æ”¯å‡º (TWD)</span><span className="font-bold text-green-700">{totalTWD.toLocaleString()}</span></div>
                        <div className="bg-white p-3 rounded border border-green-300">
                            <p className="font-bold text-green-800">{settlementMessage}</p>
                        </div>
                    </div>

                    {/* è²»ç”¨åˆ—è¡¨ */}
                    <div className="space-y-3">
                        {expenses.map(exp => (
                            <div key={exp.id} className="glass-light p-4 rounded-lg shadow-md border border-gray-100 relative">
                                <button onClick={() => removeExpense(exp.id)} className="absolute top-2 right-2 text-red-400 hover:text-red-600">âœ•</button>
                                <input 
                                    type="text" 
                                    value={exp.name} 
                                    placeholder="é …ç›®åç¨±"
                                    onChange={(e) => handleExpenseChange(exp.id, 'name', e.target.value)}
                                    className="block w-full text-lg font-semibold mb-2 bg-transparent border-b border-dashed border-gray-300 focus:border-indigo-500 outline-none"
                                />
                                <div className="flex justify-between items-center">
                                    <select 
                                        value={exp.paidBy} 
                                        onChange={(e) => handleExpenseChange(exp.id, 'paidBy', e.target.value)} 
                                        className="bg-white border rounded p-1 text-sm"
                                    >
                                        {TRAVELERS.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                    <div className="flex items-center">
                                        <span className="mr-1 text-xs text-gray-500">Â¥</span>
                                        <input 
                                            type="number" 
                                            value={exp.amount === 0 ? '' : exp.amount} 
                                            onChange={(e) => handleExpenseChange(exp.id, 'amount', parseInt(e.target.value) || 0)}
                                            className="expense-input w-24 text-lg font-bold text-right"
                                        />
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <button 
                        onClick={addExpense} 
                        className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg mt-6 shadow-md hover:bg-indigo-700 transition-colors"
                        disabled={!isFirebaseLoaded}
                    >
                        + æ–°å¢è²»ç”¨é …ç›® (é›²ç«¯åŒæ­¥)
                    </button>

                    <div className="mt-10 pt-4 border-t border-gray-200">
                        <h3 className="font-bold mb-2">å‚™è¨» (é›²ç«¯åŒæ­¥)</h3>
                        <textarea 
                            value={notes} 
                            onChange={handleNotesChange} 
                            className="w-full p-3 text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500 h-32" 
                            placeholder="è¨˜éŒ„å…¬è²»ã€ç‰¹æ®Šåˆ†å¸³æ¯”ä¾‹ç­‰è³‡è¨Š..." 
                        />
                    </div>
                </div>
            );
        };

        // ====================================================================
        // END: Firebase é›²ç«¯è¨˜å¸³é‚è¼¯
        // ====================================================================
        
        const App = () => {
            const [activeTab, setActiveTab] = useLocalStorageState('activeTab', 'itinerary');
            const [currentDayIndex, setCurrentDayIndex] = useLocalStorageState('currentDayIndex', 0);
            const [tripDatas, setTripDatas] = useLocalStorageState('tripDatas', initialTripData);
            const [isMapOpen, setIsMapOpen] = useState(false);
            
            // --- åˆ†å¸³ç³»çµ±ç‹€æ…‹ ---
            const [notes, setNotes] = useLocalStorageState('splitNotes', 'å¯åœ¨æ­¤è™•è¨˜éŒ„åŒ¯ç‡è®Šå‹•ã€ç‰¹æ®Šåˆ†å¸³æ¯”ä¾‹ç­‰è³‡è¨Šã€‚');
            
            const currentDayData = tripDatas[currentDayIndex] || tripDatas[0];
            const maxDay = tripDatas.length;

            const updateDailyMemo = useCallback((newMemo) => {
                const newTripDatas = [...tripDatas];
                newTripDatas[currentDayIndex] = { ...newTripDatas[currentDayIndex], memo: newMemo };
                setTripDatas(newTripDatas);
            }, [tripDatas, currentDayIndex, setTripDatas]);

            const NavArrow = ({ direction, onClick, disabled }) => (
                <button onClick={onClick} disabled={disabled} className={`p-2 font-bold ${disabled ? 'text-gray-300' : 'text-indigo-600'}`}>
                    {direction === 'left' ? 'â†' : 'â†’'}
                </button>
            );

            // è¡Œç¨‹å–®æ—¥é¡¯ç¤ºå…ƒä»¶
            const DailyItinerary = ({ dayData, currentDayIndex, maxDay, setCurrentDayIndex }) => {
                const [dailyMemo, setDailyMemo] = useState(dayData.memo);
                
                // --- æ»‘å‹•æ‰‹å‹¢é‚è¼¯ (æ–°å¢/ä¿®æ­£) ---
                const [touchStartX, setTouchStartX] = useState(0);
                const SWIPE_THRESHOLD = 50; // å®šç¾©æ»‘å‹•æœ€å°è·é›¢ (åƒç´ )
                
                const handleTouchStart = (e) => {
                    if (e.touches.length === 1) {
                        setTouchStartX(e.touches[0].clientX);
                    }
                };

                const handleTouchEnd = (e) => {
                    if (e.changedTouches.length !== 1 || touchStartX === 0) return;
                    
                    const touchEndX = e.changedTouches[0].clientX;
                    const deltaX = touchEndX - touchStartX;
                    
                    if (Math.abs(deltaX) < SWIPE_THRESHOLD) return; // æ»‘å‹•è·é›¢å¤ªå°ï¼Œå¿½ç•¥

                    // å‘å·¦æ»‘ (ä¸‹ä¸€å¤©)
                    if (deltaX < -SWIPE_THRESHOLD && currentDayIndex < maxDay - 1) { 
                        setCurrentDayIndex(prev => prev + 1);
                    } 
                    // å‘å³æ»‘ (å‰ä¸€å¤©)
                    else if (deltaX > SWIPE_THRESHOLD && currentDayIndex > 0) { 
                        setCurrentDayIndex(prev => prev - 1);
                    }
                    setTouchStartX(0); // é‡ç½®
                };
                // ---------------------------------
                
                useEffect(() => {
                    setDailyMemo(dayData.memo);
                }, [dayData.memo]);

                const handleMemoChange = (e) => {
                    setDailyMemo(e.target.value);
                    updateDailyMemo(e.target.value);
                };
                
                const background = getBackgroundStyle(dayData.location);
                
                const TypeIcon = ({ type }) => {
                    switch (type) {
                        case 'transport': return <span className="text-xl">âœˆï¸</span>;
                        case 'sight': return <span className="text-xl">â›©ï¸</span>;
                        case 'food': return <span className="text-xl">ğŸ½ï¸</span>;
                        case 'shopping': return <span className="text-xl">ğŸ›ï¸</span>;
                        case 'accommodation': return <span className="text-xl">ğŸ¨</span>;
                        case 'amusement': return <span className="text-xl">ğŸ¢</span>;
                        case 'leisure': return <span className="text-xl">ğŸ›€</span>;
                        default: return <span className="text-xl">ğŸ“</span>;
                    }
                };

                const EventCard = ({ event }) => (
                    <div className={`card-container glass-light card-shadow`}>
                        <div className="p-4">
                            <div className="flex justify-between items-start">
                                <div className="flex items-center space-x-3">
                                    <TypeIcon type={event.type} />
                                    <div>
                                        <div className="text-xs text-gray-500 font-medium">{event.time}</div>
                                        <div className="text-lg font-bold text-gray-800 leading-tight">{event.title}</div>
                                    </div>
                                </div>
                                {event.link && (
                                    <a href={event.link} target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:text-indigo-800 p-2 rounded-full transition-colors" title="åœ°åœ–/é€£çµ (é›¢ç·šç„¡æ³•é–‹å•Ÿ)">
                                        ğŸ”—
                                    </a>
                                )}
                            </div>
                            {(event.transport_note || event.event_note) && (
                                <div className="mt-3 pt-3 border-t border-gray-100 space-y-2 text-sm text-gray-600">
                                    {event.transport_note && (
                                        <div className="flex items-start">
                                            <span className="font-semibold w-16 flex-shrink-0 text-indigo-500">äº¤é€šï¼š</span>
                                            <span className="flex-1">{event.transport_note}</span>
                                        </div>
                                    )}
                                    {event.event_note && (
                                        <div className="flex items-start">
                                            <span className="font-semibold w-16 flex-shrink-0 text-green-600">å‚™è¨»ï¼š</span>
                                            <span className="flex-1">{event.event_note}</span>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                );

                return (
                    // ã€ä¿®æ­£é» 2ã€‘: åœ¨ DailyItinerary çš„æ ¹å…ƒç´ ä¸Šç¶å®šäº‹ä»¶
                    <div 
                        className={background.className} 
                        style={background.style}
                        onTouchStart={handleTouchStart}
                        onTouchEnd={handleTouchEnd}
                    >
                        <header className="px-4 py-4 sticky top-0 bg-white/90 backdrop-blur-sm z-10 border-b border-gray-100">
                            <h2 className="text-2xl font-bold text-indigo-700 date-style">{dayData.date}</h2>
                            <p className="text-sm text-gray-600 mt-1">åœ°é»ï¼š{dayData.location}</p>
                            <p className="text-sm font-semibold text-gray-800 mt-1">
                                {getWeatherIcon(dayData.weather)}
                            </p>
                            <div className="text-xs text-gray-500 mt-1 flex items-center flex-wrap">
                                <span className="font-medium mr-2">æ°£æº«è®ŠåŒ– ({dayData.temp_hour_range}):</span>
                                <div className="flex items-center text-gray-700 font-semibold space-x-1">
                                    {formatTemperatures(dayData.temperature)}
                                </div>
                            </div>
                        </header>
                        <section className="p-4">
                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-lg shadow-sm mb-6 mx-4">
                                <h3 className="font-semibold text-yellow-800 mb-2">æ¯æ—¥æé†’èˆ‡å‚™è¨» (å¯ç·¨è¼¯ï¼Œé›¢ç·šå„²å­˜)</h3>
                                <textarea 
                                    value={dailyMemo} 
                                    onChange={handleMemoChange} 
                                    className="w-full p-2 text-sm text-gray-700 bg-yellow-50 focus:ring-yellow-500 focus:border-yellow-500 h-20 outline-none" 
                                />
                            </div>
                            <div className="space-y-4 pb-20">
                                {dayData.events.map((ev, i) => (
                                    <EventCard key={i} event={ev} />
                                ))}
                            </div>
                        </section>
                    </div>
                );
            };

            // è³‡è¨Šç¸½è¦½å…ƒä»¶
            const ToolSection = ({ title, data, renderItem }) => (
                <div className="mb-8">
                    <h2 className="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">{title}</h2>
                    <div className="space-y-3">
                        {data.map(renderItem)}
                    </div>
                </div>
            );

            const renderTools = () => (
                <div className="p-4 pt-6 pb-20">
                    <ToolSection title="âœˆï¸ èˆªç­è³‡è¨Š" data={toolsData.flights} renderItem={(flight, index) => (
                        <div key={index} className="glass-light p-4 rounded-lg shadow-md border border-gray-100">
                            <p className="text-lg font-semibold text-indigo-700">{flight.code} - {flight.leg}</p>
                            <p className="text-sm text-gray-600">{flight.time}</p>
                            <p className="text-xs text-gray-500">æ©Ÿå ´ï¼š{flight.airport}</p>
                        </div>
                    )} />
                    
                    <ToolSection title="ğŸ¨ ä½å®¿è³‡è¨Š" data={toolsData.hotels} renderItem={(hotel, index) => (
                        <div key={index} className="glass-light p-4 rounded-lg shadow-md border border-gray-100">
                            <p className="text-lg font-semibold text-green-700">{hotel.name}</p>
                            <p className="text-sm text-gray-600">æ—¥æœŸï¼š{hotel.dates}</p>
                            <p className="text-xs text-gray-500">åœ°å€ï¼š{hotel.address}</p>
                            <p className="text-xs text-gray-500">é›»è©±ï¼š<a href={`tel:${hotel.phone}`} className="text-blue-600 underline">{hotel.phone}</a></p>
                        </div>
                    )} />

                    <ToolSection title="ğŸ« é›»å­ç¥¨åˆ¸ & é ç´„" data={toolsData.tickets} renderItem={(ticket, index) => (
                        <div key={index} className="glass-light p-4 rounded-lg shadow-md border border-gray-100 flex justify-between items-center">
                            <div>
                                <p className="text-lg font-semibold text-green-700">{ticket.name}</p>
                                <p className="text-sm text-gray-600">æ—¥æœŸï¼š{ticket.date} | é¡å‹ï¼š{ticket.type}</p>
                            </div>
                            <a href={ticket.link} target="_blank" rel="noopener noreferrer" className="bg-green-100 text-green-700 font-bold py-2 px-4 rounded-full text-sm hover:bg-green-200 transition-colors" title="é»æ“Šé–‹å•Ÿ (é›¢ç·šç„¡æ³•é–‹å•Ÿ)">
                                é€£çµ/QR
                            </a>
                        </div>
                    )} />

                    <ToolSection title="ğŸš¨ ç·Šæ€¥è¯çµ¡æ–¹å¼" data={toolsData.emergency} renderItem={(contact, index) => (
                        <div key={index} className="glass-light p-4 rounded-lg shadow-md border border-gray-100">
                            <p className="text-lg font-semibold text-red-600">{contact.name}</p>
                            <p className="text-sm text-gray-600">é›»è©±ï¼š<a href={`tel:${contact.phone}`} className="text-blue-600 underline">{contact.phone}</a></p>
                        </div>
                    )} />
                </div>
            );

            const MapViewer = () => !isMapOpen ? null : (
                <div className="map-viewer" onClick={() => setIsMapOpen(false)}>
                    <img src={MAP_IMAGE_URL} alt="åœ°éµè·¯ç·šåœ–" className="map-image" onClick={e => e.stopPropagation()} />
                </div>
            );
            
            const renderMap = () => (
                <div className="p-4 pt-6 pb-20 bg-white min-h-screen"> 
                    <h1 className="text-3xl font-extrabold text-gray-900 mb-6">ğŸ—ºï¸ åœ°éµè·¯ç·šåœ–</h1> 
                    <div className="bg-gray-100 p-4 rounded-lg shadow-lg flex justify-center items-center">
                        <img 
                            src={MAP_IMAGE_URL} 
                            alt="åœ°éµè·¯ç·šåœ–" 
                            className="w-full h-auto cursor-zoom-in rounded-lg shadow-md" 
                            onClick={() => setIsMapOpen(true)}
                        />
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-[#FBF9F2]">
                    <div className="sticky top-0 left-0 right-0 bg-white/95 z-20 shadow-sm flex justify-around p-2 border-b">
                        {['itinerary', 'tools', 'split', 'map'].map(tab => (
                            <button 
                                key={tab} 
                                onClick={() => setActiveTab(tab)} 
                                className={`flex-1 py-2 text-center text-sm font-semibold ${activeTab === tab ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-400'}`}
                            >
                                {tab === 'itinerary' ? 'è¡Œç¨‹' : tab === 'tools' ? 'è³‡è¨Š' : tab === 'split' ? 'è¨˜å¸³' : 'åœ°åœ–'}
                            </button>
                        ))}
                    </div>

                    <div 
                        className="max-w-4xl mx-auto"
                        // ç§»é™¤é€™è£¡çš„ onTouchStart/onTouchEnd ç¶å®š
                    >
                        {activeTab === 'itinerary' && 
                            <DailyItinerary 
                                dayData={currentDayData} 
                                currentDayIndex={currentDayIndex}
                                maxDay={maxDay}
                                setCurrentDayIndex={setCurrentDayIndex}
                            />
                        }
                        {activeTab === 'tools' && renderTools()}
                        {activeTab === 'split' && <SplitTool notes={notes} setNotes={setNotes} />}
                        {activeTab === 'map' && renderMap()}
                    </div>
                    
                    <MapViewer />

                    {/* æ—¥æœŸå°èˆª (Sticky Footer) - ä¿æŒä¸è®Š */}
                    {activeTab === 'itinerary' && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t border-gray-200 shadow-2xl z-30">
                            <div className="max-w-4xl mx-auto p-3 flex justify-between items-center">
                                <NavArrow 
                                    direction="left"
                                    onClick={() => setCurrentDayIndex(prev => Math.max(0, prev - 1))}
                                    disabled={currentDayIndex === 0}
                                />
                                <div className="text-xl font-extrabold text-indigo-700 date-style">
                                    DAY {currentDayIndex + 1} / {maxDay}
                                </div>
                                <NavArrow 
                                    direction="right"
                                    onClick={() => setCurrentDayIndex(prev => Math.min(maxDay - 1, prev + 1))}
                                    disabled={currentDayIndex === maxDay - 1}
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
